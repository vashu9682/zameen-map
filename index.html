<!DOCTYPE html>
<html>
<head>
  <title>Zameen Map Area Calculator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; }
    body { font-family: Arial; margin: 10px; }
    button { margin: 5px; padding: 10px; font-weight: bold; }
    select { padding: 8px; font-size: 16px; margin: 5px; }
    .unit-info { font-size: 12px; color: #666; }
    #unitConversion { margin: 10px 0; }
    #gpsWarning { color: red; font-weight: bold; display: none; }
  </style>
</head>
<body>

<h2>üìç Zameen Map Area Calculatorr</h2>
<div id="gpsWarning">‚ö†Ô∏è GPS is disabled. Please enable to add points.</div>

<div id="map"></div>

<button onclick="addManualPoint()">+ Add Manual Point</button>
<button onclick="clearPoints()">‚ùå Clear Points</button>
<button onclick="calculateArea()">üìê Calculate Area</button>

<div id="unitConversion">
  <h3>Select Measurement Unit:</h3>
  <select id="unitSelect" onchange="showUnitInfo()">
    <option value="sqft">‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Foot)</option>
    <option value="sqm">‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meter)</option>
    <option value="dismil">‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Decimal/Dismil)</option>
    <option value="katha">‡§ï‡§†‡•ç‡§†‡§æ (Katha - Bihar/UP)</option>
    <option value="bigha">‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar)</option>
    <option value="bigha_up">‡§¨‡•Ä‡§ò‡§æ (Bigha - UP)</option>
    <option value="acre">‡§è‡§ï‡§°‡§º (Acre)</option>
    <option value="hectare">‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (Hectare)</option>
    <option value="guntha">‡§ó‡•Å‡§Ç‡§†‡§æ (Guntha - Maharashtra)</option>
    <option value="cent">‡§∏‡•á‡§Ç‡§ü (Cent)</option>
  </select>
  <p class="unit-info" id="unitInfo">1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü = 1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü</p>
</div>

<p id="output"></p>

<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Turf.js -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
  let coordinates = [];
  let map = L.map('map').setView([25.0, 82.0], 18); // default location
  let gpsEnabled = false;

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
  }).addTo(map);

  let polygon;
  let markers = [];

  // Unit conversion factors (to square feet)
  const unitConversions = {
    sqft: { name: "‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Foot)", factor: 1, info: "1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü = 1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    sqm: { name: "‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meter)", factor: 10.7639, info: "1 ‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ = 10.7639 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    dismil: { name: "‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Decimal/Dismil)", factor: 435.6, info: "1 ‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ = 435.6 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    katha: { name: "‡§ï‡§†‡•ç‡§†‡§æ (Katha)", factor: 1361, info: "1 ‡§ï‡§†‡•ç‡§†‡§æ = 1361 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Bihar standard)" },
    bigha: { name: "‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar)", factor: 27220, info: "1 ‡§¨‡•Ä‡§ò‡§æ = 27,220 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (20 ‡§ï‡§†‡•ç‡§†‡§æ)" },
    bigha_up: { name: "‡§¨‡•Ä‡§ò‡§æ (Bigha - UP)", factor: 27000, info: "1 ‡§¨‡•Ä‡§ò‡§æ = 27,000 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (20 ‡§ï‡§†‡•ç‡§†‡§æ)" },
    acre: { name: "‡§è‡§ï‡§°‡§º (Acre)", factor: 43560, info: "1 ‡§è‡§ï‡§°‡§º = 43,560 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    hectare: { name: "‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (Hectare)", factor: 107639, info: "1 ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ = 107,639 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    guntha: { name: "‡§ó‡•Å‡§Ç‡§†‡§æ (Guntha)", factor: 1089, info: "1 ‡§ó‡•Å‡§Ç‡§†‡§æ = 1,089 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Maharashtra)" },
    cent: { name: "‡§∏‡•á‡§Ç‡§ü (Cent)", factor: 435.6, info: "1 ‡§∏‡•á‡§Ç‡§ü = 435.6 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" }
  };

  function showUnitInfo() {
    const unit = document.getElementById("unitSelect").value;
    document.getElementById("unitInfo").textContent = unitConversions[unit].info;
  }

  function drawLineOnMap() {
    // Clear existing markers
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    // Add new markers
    coordinates.forEach((coord, index) => {
      const marker = L.marker([coord[1], coord[0]])
        .bindPopup(`Point ${index+1}<br>Lat: ${coord[1].toFixed(6)}<br>Lng: ${coord[0].toFixed(6)}`)
        .addTo(map);
      markers.push(marker);
    });
    
    // Draw polygon
    if (polygon) map.removeLayer(polygon);
    if (coordinates.length > 1) {
      polygon = L.polygon(coordinates.map(p => [p[1], p[0]]), { color: 'blue' }).addTo(map);
      map.fitBounds(polygon.getBounds());
    }
  }

  function clearPoints() {
    coordinates = [];
    if (polygon) map.removeLayer(polygon);
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    document.getElementById("output").innerHTML = "";
  }

  // Check GPS status and redirect to settings if disabled
  function checkGPSPermission() {
    if (!navigator.permissions) {
      return Promise.resolve(false);
    }
    return navigator.permissions.query({name:'geolocation'})
      .then(permissionStatus => {
        return permissionStatus.state === 'granted';
      })
      .catch(() => false);
  }

  function redirectToLocationSettings() {
    // For Chrome on Android
    if (navigator.userAgent.includes('Android') && navigator.userAgent.includes('Chrome')) {
      window.location.href = 'chrome://settings/content/location';
    }
    // For other browsers/devices, we can't redirect directly to settings
    alert("Please enable GPS/Location in your device settings and browser permissions");
  }

  function addManualPoint() {
    checkGPSPermission().then(enabled => {
      if (!enabled) {
        document.getElementById("gpsWarning").style.display = 'block';
        redirectToLocationSettings();
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function (position) {
          gpsEnabled = true;
          document.getElementById("gpsWarning").style.display = 'none';
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          coordinates.push([lng, lat]);
          drawLineOnMap();
        },
        function(error) {
          gpsEnabled = false;
          document.getElementById("gpsWarning").style.display = 'block';
          if (error.code === error.PERMISSION_DENIED) {
            redirectToLocationSettings();
          } else {
            alert("GPS Error: " + error.message);
          }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  // Auto track user location (only if GPS is enabled)
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      function (position) {
        gpsEnabled = true;
        document.getElementById("gpsWarning").style.display = 'none';
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        map.setView([lat, lng], 18);
      },
      function (error) {
        gpsEnabled = false;
        document.getElementById("gpsWarning").style.display = 'block';
        console.error("Location error: ", error);
      },
      { enableHighAccuracy: true, maximumAge: 1000 }
    );
  } else {
    alert("GPS not supported by your browser");
  }

  function calculateArea() {
    if (coordinates.length < 3) {
      alert("‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 3 ‡§™‡•â‡§á‡§Ç‡§ü ‡§ö‡§æ‡§π‡§ø‡§è ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è‡•§");
      return;
    }

    // Close the polygon
    const coords = [...coordinates, coordinates[0]];
    const polygonGeoJSON = turf.polygon([coords]);
    const area_m2 = turf.area(polygonGeoJSON);
    const area_sqft = area_m2 * 10.7639;

    const unit = document.getElementById("unitSelect").value;
    const unitData = unitConversions[unit];
    const area_in_unit = area_sqft / unitData.factor;

    document.getElementById("output").innerHTML = `
      <h3>üßÆ Area Result:</h3>
      <p><b>Selected Unit:</b> ${unitData.name}</p>
      <p><b>Total Area:</b> ${area_in_unit.toFixed(4)} ${unitData.name.split('(')[0].trim()}</p>
      
      <h4>Other Unit Conversions:</h4>
      <ul>
        <li><b>‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Feet):</b> ${area_sqft.toFixed(2)}</li>
        <li><b>‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meters):</b> ${area_m2.toFixed(2)}</li>
        <li><b>‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Dismil):</b> ${(area_sqft / 435.6).toFixed(4)}</li>
        <li><b>‡§ï‡§†‡•ç‡§†‡§æ (Katha - Bihar):</b> ${(area_sqft / 1361).toFixed(4)}</li>
        <li><b>‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar):</b> ${(area_sqft / 27220).toFixed(4)}</li>
        <li><b>‡§è‡§ï‡§°‡§º (Acre):</b> ${(area_sqft / 43560).toFixed(4)}</li>
      </ul>
    `;
  }

  // Initialize unit info
  showUnitInfo();
</script>

</body>
</html>