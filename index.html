<!DOCTYPE html>
<html>
<head>
  <title>Zameen Map Area Calculator</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; width: 100%; }
    body { font-family: Arial; margin: 10px; }
    button { margin: 5px; padding: 10px; font-weight: bold; }
    select { padding: 8px; font-size: 16px; margin: 5px; }
    .unit-info { font-size: 12px; color: #666; }
    #unitConversion { margin: 10px 0; }
    #gpsWarning { color: red; font-weight: bold; display: none; }
    .distance-label {
      background: white;
      padding: 2px 5px;
      border-radius: 3px;
      font-size: 12px;
      pointer-events: none;
    }
    @media (max-width: 600px) {
      button { width: 100%; margin: 5px 0; }
      select { width: 100%; }
    }
  </style>
</head>
<body>

<h2>üìç Zameen Map Area Calculator</h2>
<div id="gpsWarning">‚ö†Ô∏è GPS is disabled. Please enable to add points.</div>

<div id="map"></div>

<button onclick="addManualPoint()">+ Add Manual Point</button>
<button onclick="joinPoints()">üîó Join Points</button>
<button onclick="clearPoints()">‚ùå Clear Points</button>
<button onclick="calculateArea()">üìê Calculate Area</button>
<button onclick="zoomToShape()">üîç Zoom to Shape</button>

<div id="unitConversion">
  <h3>Select Measurement Unit:</h3>
  <select id="unitSelect" onchange="showUnitInfo()">
    <option value="sqft">‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Foot)</option>
    <option value="sqm">‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meter)</option>
    <option value="dismil">‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Decimal/Dismil)</option>
    <option value="katha">‡§ï‡§†‡•ç‡§†‡§æ (Katha - Bihar/UP)</option>
    <option value="bigha">‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar)</option>
    <option value="bigha_up">‡§¨‡•Ä‡§ò‡§æ (Bigha - UP)</option>
    <option value="acre">‡§è‡§ï‡§°‡§º (Acre)</option>
    <option value="hectare">‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (Hectare)</option>
    <option value="guntha">‡§ó‡•Å‡§Ç‡§†‡§æ (Guntha - Maharashtra)</option>
    <option value="cent">‡§∏‡•á‡§Ç‡§ü (Cent)</option>
  </select>
  <p class="unit-info" id="unitInfo">1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü = 1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü</p>
</div>

<p id="output"></p>

<!-- Leaflet.js -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- Turf.js -->
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
  let coordinates = [];
  let map = L.map('map').setView([25.0, 82.0], 18); // default location
  let gpsEnabled = false;
  let dynamicLine = null;
  let dynamicMarker = null;
  let lineSegments = [];
  let distanceLabels = [];

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 22,
  }).addTo(map);

  let polygon;
  let markers = [];

  // Unit conversion factors (to square feet)
  const unitConversions = {
    sqft: { name: "‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Foot)", factor: 1, info: "1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü = 1 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    sqm: { name: "‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meter)", factor: 10.7639, info: "1 ‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ = 10.7639 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    dismil: { name: "‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Decimal/Dismil)", factor: 435.6, info: "1 ‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ = 435.6 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    katha: { name: "‡§ï‡§†‡•ç‡§†‡§æ (Katha)", factor: 1361, info: "1 ‡§ï‡§†‡•ç‡§†‡§æ = 1361 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Bihar standard)" },
    bigha: { name: "‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar)", factor: 27220, info: "1 ‡§¨‡•Ä‡§ò‡§æ = 27,220 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (20 ‡§ï‡§†‡•ç‡§†‡§æ)" },
    bigha_up: { name: "‡§¨‡•Ä‡§ò‡§æ (Bigha - UP)", factor: 27000, info: "1 ‡§¨‡•Ä‡§ò‡§æ = 27,000 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (20 ‡§ï‡§†‡•ç‡§†‡§æ)" },
    acre: { name: "‡§è‡§ï‡§°‡§º (Acre)", factor: 43560, info: "1 ‡§è‡§ï‡§°‡§º = 43,560 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    hectare: { name: "‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ (Hectare)", factor: 107639, info: "1 ‡§π‡•á‡§ï‡•ç‡§ü‡•á‡§Ø‡§∞ = 107,639 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" },
    guntha: { name: "‡§ó‡•Å‡§Ç‡§†‡§æ (Guntha)", factor: 1089, info: "1 ‡§ó‡•Å‡§Ç‡§†‡§æ = 1,089 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Maharashtra)" },
    cent: { name: "‡§∏‡•á‡§Ç‡§ü (Cent)", factor: 435.6, info: "1 ‡§∏‡•á‡§Ç‡§ü = 435.6 ‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü" }
  };

  function showUnitInfo() {
    const unit = document.getElementById("unitSelect").value;
    document.getElementById("unitInfo").textContent = unitConversions[unit].info;
  }

  function drawLineOnMap() {
    // Clear existing markers and lines
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    clearDistanceLabels();
    lineSegments.forEach(segment => map.removeLayer(segment));
    lineSegments = [];
    
    // Add new markers
    coordinates.forEach((coord, index) => {
      const marker = L.marker([coord[1], coord[0]])
        .bindPopup(`Point ${index+1}<br>Lat: ${coord[1].toFixed(6)}<br>Lng: ${coord[0].toFixed(6)}`)
        .addTo(map);
      markers.push(marker);
    });
    
    // Draw polygon and line segments with distances
    if (polygon) map.removeLayer(polygon);
    if (coordinates.length > 1) {
      // Draw connecting lines with distance labels
      for (let i = 0; i < coordinates.length; i++) {
        const nextIndex = (i + 1) % coordinates.length;
        const start = coordinates[i];
        const end = coordinates[nextIndex];
        
        // Draw line segment
        const line = L.polyline(
          [[start[1], start[0]], [end[1], end[0]]],
          {color: 'blue', weight: 3}
        ).addTo(map);
        lineSegments.push(line);
        
        // Calculate distance
        const distance = turf.distance(
          turf.point([start[0], start[1]]),
          turf.point([end[0], end[1]]),
          {units: 'meters'}
        );
        
        // Add distance label at midpoint
        const midPoint = turf.midpoint(
          turf.point([start[0], start[1]]),
          turf.point([end[0], end[1]])
        );
        
        const label = L.marker([midPoint.geometry.coordinates[1], midPoint.geometry.coordinates[0]], {
          icon: L.divIcon({
            html: `<div class="distance-label">${distance.toFixed(2)} m</div>`,
            className: 'distance-label-container',
            iconSize: [100, 20]
          }),
          interactive: false
        }).addTo(map);
        distanceLabels.push(label);
      }
      
      polygon = L.polygon(coordinates.map(p => [p[1], p[0]]), { color: 'blue', fillOpacity: 0.2 }).addTo(map);
      map.fitBounds(polygon.getBounds());
    }
  }

  function clearDistanceLabels() {
    distanceLabels.forEach(label => map.removeLayer(label));
    distanceLabels = [];
  }

  function clearPoints() {
    coordinates = [];
    if (polygon) map.removeLayer(polygon);
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    lineSegments.forEach(segment => map.removeLayer(segment));
    lineSegments = [];
    clearDistanceLabels();
    document.getElementById("output").innerHTML = "";
    if (dynamicLine) map.removeLayer(dynamicLine);
    if (dynamicMarker) map.removeLayer(dynamicMarker);
  }

  function zoomToShape() {
    if (coordinates.length > 1 && polygon) {
      map.fitBounds(polygon.getBounds());
    } else {
      alert("First create a shape with at least 2 points");
    }
  }

  function joinPoints() {
    if (coordinates.length < 2) {
      alert("At least 2 points needed to join");
      return;
    }
    
    // Find the two closest points to join
    let minDistance = Infinity;
    let point1Index = -1;
    let point2Index = -1;
    
    for (let i = 0; i < coordinates.length; i++) {
      for (let j = i + 1; j < coordinates.length; j++) {
        const distance = turf.distance(
          turf.point([coordinates[i][0], coordinates[i][1]]),
          turf.point([coordinates[j][0], coordinates[j][1]])
        );
        if (distance < minDistance) {
          minDistance = distance;
          point1Index = i;
          point2Index = j;
        }
      }
    }
    
    if (point1Index !== -1 && point2Index !== -1) {
      // Reorder coordinates to connect these points
      const newCoordinates = [...coordinates];
      if (point1Index > point2Index) {
        [point1Index, point2Index] = [point2Index, point1Index];
      }
      
      const segment1 = newCoordinates.slice(0, point1Index + 1);
      const segment2 = newCoordinates.slice(point1Index + 1, point2Index + 1);
      const segment3 = newCoordinates.slice(point2Index + 1);
      
      coordinates = [...segment1, ...segment3, ...segment2.reverse()];
      drawLineOnMap();
    }
  }

  // Check GPS status and redirect to settings if disabled
  function checkGPSPermission() {
    if (!navigator.permissions) {
      return Promise.resolve(false);
    }
    return navigator.permissions.query({name:'geolocation'})
      .then(permissionStatus => {
        return permissionStatus.state === 'granted';
      })
      .catch(() => false);
  }

  function redirectToLocationSettings() {
    // For Chrome on Android
    if (navigator.userAgent.includes('Android') && navigator.userAgent.includes('Chrome')) {
      window.location.href = 'chrome://settings/content/location';
    }
    // For other browsers/devices, we can't redirect directly to settings
    alert("Please enable GPS/Location in your device settings and browser permissions");
  }

  function updateDynamicLine(position) {
    if (coordinates.length === 0) return;
    
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    
    // Update dynamic line from last point to current position
    if (dynamicLine) map.removeLayer(dynamicLine);
    if (dynamicMarker) map.removeLayer(dynamicMarker);
    
    const lastPoint = coordinates[coordinates.length - 1];
    dynamicLine = L.polyline(
      [[lastPoint[1], lastPoint[0]], [lat, lng]],
      {color: 'red', dashArray: '5,5', weight: 2}
    ).addTo(map);
    
    // Add marker at current position with distance info
    const distance = turf.distance(
      turf.point([lastPoint[0], lastPoint[1]]),
      turf.point([lng, lat]),
      {units: 'meters'}
    );
    
    dynamicMarker = L.marker([lat, lng], {
      icon: L.divIcon({
        html: `<div class="distance-label">${distance.toFixed(2)} m</div>`,
        className: 'distance-label-container',
        iconSize: [100, 20]
      })
    }).addTo(map);
  }

  function addManualPoint() {
    checkGPSPermission().then(enabled => {
      if (!enabled) {
        document.getElementById("gpsWarning").style.display = 'block';
        redirectToLocationSettings();
        return;
      }
      
      navigator.geolocation.getCurrentPosition(
        function (position) {
          gpsEnabled = true;
          document.getElementById("gpsWarning").style.display = 'none';
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          coordinates.push([lng, lat]);
          drawLineOnMap();
          
          // Start tracking movement if this is the first point
          if (coordinates.length === 1) {
            startTrackingMovement();
          }
        },
        function(error) {
          gpsEnabled = false;
          document.getElementById("gpsWarning").style.display = 'block';
          if (error.code === error.PERMISSION_DENIED) {
            redirectToLocationSettings();
          } else {
            alert("GPS Error: " + error.message);
          }
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  let watchId = null;
  function startTrackingMovement() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
    }
    
    watchId = navigator.geolocation.watchPosition(
      function(position) {
        updateDynamicLine(position);
      },
      function(error) {
        console.error("Tracking error:", error);
      },
      { enableHighAccuracy: true, maximumAge: 1000 }
    );
  }

  function stopTrackingMovement() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
    if (dynamicLine) map.removeLayer(dynamicLine);
    if (dynamicMarker) map.removeLayer(dynamicMarker);
  }

  // Auto track user location (only if GPS is enabled)
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(
      function (position) {
        gpsEnabled = true;
        document.getElementById("gpsWarning").style.display = 'none';
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        map.setView([lat, lng], 18);
      },
      function (error) {
        gpsEnabled = false;
        document.getElementById("gpsWarning").style.display = 'block';
        console.error("Location error: ", error);
      },
      { enableHighAccuracy: true, maximumAge: 1000 }
    );
  } else {
    alert("GPS not supported by your browser");
  }

  function calculateArea() {
    if (coordinates.length < 3) {
      alert("‡§ï‡§Æ ‡§∏‡•á ‡§ï‡§Æ 3 ‡§™‡•â‡§á‡§Ç‡§ü ‡§ö‡§æ‡§π‡§ø‡§è ‡§è‡§∞‡§ø‡§Ø‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è‡•§");
      return;
    }

    // Close the polygon
    const coords = [...coordinates, coordinates[0]];
    const polygonGeoJSON = turf.polygon([coords]);
    const area_m2 = turf.area(polygonGeoJSON);
    const area_sqft = area_m2 * 10.7639;

    const unit = document.getElementById("unitSelect").value;
    const unitData = unitConversions[unit];
    const area_in_unit = area_sqft / unitData.factor;

    // Calculate perimeter
    let perimeter = 0;
    for (let i = 0; i < coords.length - 1; i++) {
      perimeter += turf.distance(
        turf.point([coords[i][0], coords[i][1]]),
        turf.point([coords[i+1][0], coords[i+1][1]]),
        {units: 'meters'}
      );
    }

    document.getElementById("output").innerHTML = `
      <h3>üßÆ Area Result:</h3>
      <p><b>Selected Unit:</b> ${unitData.name}</p>
      <p><b>Total Area:</b> ${area_in_unit.toFixed(4)} ${unitData.name.split('(')[0].trim()}</p>
      <p><b>Perimeter:</b> ${perimeter.toFixed(2)} meters</p>
      
      <h4>Other Unit Conversions:</h4>
      <ul>
        <li><b>‡§µ‡§∞‡•ç‡§ó ‡§´‡•Å‡§ü (Square Feet):</b> ${area_sqft.toFixed(2)}</li>
        <li><b>‡§µ‡§∞‡•ç‡§ó ‡§Æ‡•Ä‡§ü‡§∞ (Square Meters):</b> ${area_m2.toFixed(2)}</li>
        <li><b>‡§°‡§ø‡§∏‡§Æ‡§ø‡§≤ (Dismil):</b> ${(area_sqft / 435.6).toFixed(4)}</li>
        <li><b>‡§ï‡§†‡•ç‡§†‡§æ (Katha - Bihar):</b> ${(area_sqft / 1361).toFixed(4)}</li>
        <li><b>‡§¨‡•Ä‡§ò‡§æ (Bigha - Bihar):</b> ${(area_sqft / 27220).toFixed(4)}</li>
        <li><b>‡§è‡§ï‡§°‡§º (Acre):</b> ${(area_sqft / 43560).toFixed(4)}</li>
      </ul>
    `;
  }

  // Initialize unit info
  showUnitInfo();
</script>

</body>
</html>